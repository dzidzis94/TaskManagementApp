@model TaskManagementApp.Models.Project

@{
    ViewData["Title"] = "Create New Project";
    var templates = ViewBag.ProjectTemplates as List<ProjectTemplate>;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-3">Create New Project</h1>
    <button id="open-sidebar-btn" class="btn btn-outline-primary">
        <i class="fas fa-layer-group me-2"></i> Choose from Template
    </button>
</div>

<div class="row">
    <div class="col-12">
        <div class="task-item p-4">
            <form asp-action="Create" id="create-project-form">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <input type="hidden" name="templateId" id="selected-template-id" />

                <div class="form-group mb-3">
                    <label asp-for="Name" class="form-label" style="color: var(--text-color);"></label>
                    <input asp-for="Name" class="form-control" placeholder="e.g., Q4 Marketing Campaign" style="background-color: var(--background-color); color: var(--text-color); border-color: var(--border-color);" />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>
                <div class="form-group mb-3">
                    <label asp-for="Description" class="form-label" style="color: var(--text-color);"></label>
                    <textarea asp-for="Description" class="form-control" rows="4" placeholder="A brief description of the project's goals and deliverables." style="background-color: var(--background-color); color: var(--text-color); border-color: var(--border-color);"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>
                <div class="form-group form-check mb-4">
                    <input class="form-check-input" asp-for="IsPublic" />
                    <label class="form-check-label" asp-for="IsPublic" style="color: var(--text-color);">
                        @Html.DisplayNameFor(model => model.IsPublic)
                    </label>
                </div>
                <div class="d-flex justify-content-end">
                    <a asp-action="Index" class="btn btn-outline-secondary me-2">Cancel</a>
                    <input type="submit" value="Create Project" class="btn btn-primary" />
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template Sidebar -->
<div id="template-sidebar" class="template-sidebar" style="background-color: var(--surface-color); color: var(--text-color); border-left: 1px solid var(--border-color);">
    <div class="template-sidebar-header" style="border-bottom: 1px solid var(--border-color);">
        <h3 class="mb-0">Project Templates</h3>
        <button id="close-sidebar-btn" class="close-sidebar-btn" style="color: var(--text-color);">&times;</button>
    </div>
    <div id="template-list" class="mt-3">
        @if (templates != null && templates.Any())
        {
            foreach (var template in templates)
            {
                <div class="template-card" data-template-id="@template.Id" data-template-name="@template.Name" data-template-description="@template.Description" style="border: 1px solid var(--border-color); background-color: var(--background-color);">
                    <h5 style="color: var(--primary-color);">@template.Name</h5>
                    <p class="small" style="color: var(--text-muted);">@template.Description</p>
                    <div class="template-card-footer" style="color: var(--text-muted);">
                        <span><i class="fas fa-tasks me-1"></i> @template.Sections.Count Sections</span>
                        <span><i class="fas fa-sitemap me-1"></i> Tasks</span>
                    </div>
                </div>
            }
        }
        else
        {
            <p style="color: var(--text-muted);">No project templates have been created yet.</p>
        }
    </div>
    <div id="template-preview-area">
        <h4 class="mb-3">Template Preview</h4>
        <div id="template-preview-content">
            <!-- AJAX content will be loaded here -->
        </div>
        <button id="apply-template-btn" class="btn btn-primary btn-apply-template mt-3" disabled>Apply Template</button>
    </div>
</div>
<div class="sidebar-overlay"></div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Defensive coding to ensure script runs after DOM is fully loaded
        (function() {
            const sidebar = document.getElementById('template-sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const openBtn = document.getElementById('open-sidebar-btn');
            const closeBtn = document.getElementById('close-sidebar-btn');

            if (!sidebar || !overlay || !openBtn || !closeBtn) {
                console.error('Sidebar components not found!');
                return;
            }

            const templateCards = document.querySelectorAll('.template-card');
            const previewArea = document.getElementById('template-preview-area');
            const previewContent = document.getElementById('template-preview-content');
            const applyBtn = document.getElementById('apply-template-btn');
            const selectedTemplateIdField = document.getElementById('selected-template-id');
            const projectNameField = document.getElementById('Name');
            const projectDescField = document.getElementById('Description');

            let selectedTemplate = null;

            function openSidebar() {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            }

            function closeSidebar() {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }

            openBtn.addEventListener('click', openSidebar);
            closeBtn.addEventListener('click', closeSidebar);
            overlay.addEventListener('click', closeSidebar);

            function renderSection(section, parentElement) {
                const listItem = document.createElement('li');
                listItem.className = 'preview-task-item';
                listItem.textContent = section.title;
                listItem.style.color = 'var(--text-color)'; // Ensure dynamic text color

                if (section.children && section.children.length > 0) {
                    const sublist = document.createElement('ul');
                    section.children.forEach(child => renderSection(child, sublist));
                    listItem.appendChild(sublist);
                }
                parentElement.appendChild(listItem);
            }

            templateCards.forEach(card => {
                card.addEventListener('click', function () {
                    const templateId = this.dataset.templateId;

                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        card.style.borderColor = 'var(--border-color)'; // Reset border
                        previewArea.style.display = 'none';
                        if(applyBtn) applyBtn.disabled = true;
                        selectedTemplate = null;
                        if(selectedTemplateIdField) selectedTemplateIdField.value = '';
                    } else {
                        templateCards.forEach(c => {
                            c.classList.remove('selected');
                            c.style.borderColor = 'var(--border-color)'; // Reset border
                        });
                        this.classList.add('selected');
                        this.style.borderColor = 'var(--primary-color)'; // Highlight border
                        if(previewArea) previewArea.style.display = 'block';
                        if(applyBtn) applyBtn.disabled = false;

                        selectedTemplate = {
                            id: templateId,
                            name: this.dataset.templateName,
                            description: this.dataset.templateDescription
                        };

                        if(previewContent) {
                            previewContent.innerHTML = '<p style="color: var(--text-muted);" class="pulse-green">Loading preview...</p>';
                            fetch(`/Projects/GetTemplatePreview/${templateId}`)
                                .then(response => {
                                    if (!response.ok) throw new Error('Network response was not ok');
                                    return response.json();
                                })
                                .then(data => {
                                    previewContent.innerHTML = '';
                                    if (data && data.length > 0) {
                                        const list = document.createElement('ul');
                                        list.style.listStyleType = 'none';
                                        list.style.paddingLeft = '0';
                                        data.forEach(section => renderSection(section, list));
                                        previewContent.appendChild(list);
                                    } else {
                                        previewContent.innerHTML = '<p style="color: var(--text-muted);">This template appears to be empty.</p>';
                                    }
                                })
                                .catch(error => {
                                    console.error('Error fetching template preview:', error);
                                    previewContent.innerHTML = '<p class="text-danger small">An error occurred while loading the preview. Please try again.</p>';
                                });
                        }
                    }
                });
            });

            if(applyBtn) {
                applyBtn.addEventListener('click', function() {
                    if (selectedTemplate) {
                        if(projectNameField) projectNameField.value = selectedTemplate.name;
                        if(projectDescField) projectDescField.value = selectedTemplate.description;
                        if(selectedTemplateIdField) selectedTemplateIdField.value = selectedTemplate.id;
                        closeSidebar();
                    }
                });
            }
        })();
    </script>
}
