@model TaskManagementApp.Models.TaskItem
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Edit Task Tree (Draft)";
    var currentUserId = UserManager.GetUserId(User);
}

<div class="container mt-4">
    <div class="alert alert-info border-info" role="alert">
        <i class="fas fa-info-circle me-2"></i> <strong>Draft Mode:</strong> You are viewing a cloned task tree. You can review and modify the structure before finalizing.
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-3">@ViewData["Title"]</h1>
            <h4 class="text-muted">@Model.Title</h4>
        </div>
        <div>
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-success"><i class="fas fa-check"></i> Done Editing</a>
            @if (User.IsInRole("Admin"))
            {
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary"><i class="fas fa-edit"></i> Edit Root Task</a>
            }
        </div>
    </div>
    <hr style="border-color: var(--border-color);" />

    <div class="row">
        <!-- Main Task Details -->
        <div class="col-lg-12">
            <div class="task-item @("task-priority-" + Model.Priority) mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0" style="color: var(--primary-color);">Description</h5>
                    <span class="status-badge status-pending">@Model.Status</span>
                </div>

                <p class="card-text" style="color: var(--text-color);">@Model.Description</p>
                <hr style="border-color: var(--border-color);" />

                <div class="row text-muted small">
                    <div class="col-md-4">
                        <div class="mb-2">
                            <strong style="color: var(--text-color);">Due Date:</strong> <br>
                            <i class="fas fa-calendar-alt me-2"></i> @(Model.DueDate?.ToString("yyyy-MM-dd") ?? "Not set")
                        </div>
                    </div>
                    <div class="col-md-4">
                         <div class="mb-2">
                             <strong style="color: var(--text-color);">Priority:</strong> <br>
                             <span class="badge @(Model.Priority == TaskManagementApp.Models.TaskPriority.High ? "bg-danger" : Model.Priority == TaskManagementApp.Models.TaskPriority.Medium ? "bg-warning text-dark" : "bg-info text-dark")">@Model.Priority</span>
                         </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-2">
                            <strong style="color: var(--text-color);">Created by:</strong> <br>
                            <i class="fas fa-user-edit me-2"></i> @Model.CreatedBy?.UserName
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subtasks -->
            <div class="task-item">
                <div class="d-flex justify-content-between align-items-center mb-3">
                     <h5 class="card-title mb-0" style="color: var(--primary-color);">Task Hierarchy</h5>
                     @if (User.IsInRole("Admin"))
                     {
                        <a asp-action="Create" asp-route-parentTaskId="@Model.Id" asp-route-projectId="@Model.ProjectId" class="btn btn-sm btn-success"><i class="fas fa-plus"></i> Add Sub-task</a>
                     }
                </div>

                @if (Model.SubTasks != null && Model.SubTasks.Any())
                {
                    <div class="sub-tasks">
                         @await Html.PartialAsync("_TaskList", Model.SubTasks.Select(MapToSummary))
                    </div>
                }
                else
                {
                    <p style="color: var(--text-muted);">No sub-tasks.</p>
                }
            </div>
        </div>
    </div>
</div>

@functions {
    TaskManagementApp.ViewModels.TaskSummaryViewModel MapToSummary(TaskManagementApp.Models.TaskItem task)
    {
        return new TaskManagementApp.ViewModels.TaskSummaryViewModel
        {
            Id = task.Id,
            Title = task.Title,
            Description = task.Description,
            Status = task.Status,
            Priority = task.Priority,
            DueDate = task.DueDate,
            ProjectId = task.ProjectId,
            ParentTaskId = task.ParentTaskId,
            CreatedAt = task.CreatedAt,
            AssignedUserNames = task.TaskAssignments?.Where(ta => ta.User != null).Select(ta => ta.User.UserName).ToList() ?? new List<string>(),
            AssignedUserIds = task.TaskAssignments?.Select(ta => ta.UserId).ToList() ?? new List<string>(),
            CompletedUserNames = task.TaskCompletions?.Where(tc => tc.User != null).Select(tc => tc.User.UserName).ToList() ?? new List<string>(),
            CompletedUserIds = task.TaskCompletions?.Select(tc => tc.UserId).ToList() ?? new List<string>(),
            SubTasks = task.SubTasks?.Select(MapToSummary).ToList() ?? new List<TaskManagementApp.ViewModels.TaskSummaryViewModel>()
        };
    }
}
