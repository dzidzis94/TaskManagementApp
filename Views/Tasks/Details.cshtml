@model TaskManagementApp.Models.TaskItem
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Task Details";
    var currentUserId = UserManager.GetUserId(User);
    var isAssigned = Model.TaskAssignments.Any(ta => ta.UserId == currentUserId);
    var hasCompleted = Model.TaskCompletions.Any(tc => tc.UserId == currentUserId);
    var canComplete = isAssigned && !hasCompleted;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-3">@Model.Title</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 m-0">
                    @if (Model.ProjectId.HasValue)
                    {
                        <li class="breadcrumb-item"><a asp-controller="Projects" asp-action="Details" asp-route-id="@Model.ProjectId">@Model.Project?.Name</a></li>
                    }
                    else
                    {
                        <li class="breadcrumb-item"><a asp-controller="Tasks" asp-action="Index">General Tasks</a></li>
                    }
                    @if (Model.ParentTaskId.HasValue)
                    {
                        <li class="breadcrumb-item"><a asp-controller="Tasks" asp-action="Details" asp-route-id="@Model.ParentTaskId">...</a></li>
                    }
                    <li class="breadcrumb-item active" aria-current="page" style="color: var(--text-color);">@Model.Title</li>
                </ol>
            </nav>
        </div>
        <div>
            <a asp-action="Index" asp-route-projectId="@Model.ProjectId" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>
            @if (User.IsInRole("Admin"))
            {
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary"><i class="fas fa-edit"></i> Edit</a>
            }
        </div>
    </div>
    <hr style="border-color: var(--border-color);" />

    <div class="row">
        <!-- Main Task Details -->
        <div class="col-lg-8">
            <div class="task-item mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3" style="color: var(--primary-color);">Description</h5>
                    <p class="card-text" style="color: var(--text-color);">@Model.Description</p>
                    <hr style="border-color: var(--border-color);" />
                    <div class="row">
                        <div class="col-md-6">
                            <strong style="color: var(--text-color);">Status:</strong> <span class="status-badge @(Model.Status == TaskManagementApp.Models.TaskStatus.Completed ? "status-completed" : Model.Status == TaskManagementApp.Models.TaskStatus.InProgress ? "status-in-progress" : "status-pending")">@Model.Status</span><br />
                            <strong style="color: var(--text-color);">Due Date:</strong> <span style="color: var(--text-muted);">@(Model.DueDate?.ToString("yyyy-MM-dd") ?? "Not set")</span>
                        </div>
                        <div class="col-md-6">
                            <strong style="color: var(--text-color);">Created by:</strong> <span style="color: var(--text-muted);">@Model.CreatedBy?.UserName</span><br />
                            <strong style="color: var(--text-color);">Created at:</strong> <span style="color: var(--text-muted);">@Model.CreatedAt.ToString("g")</span>
                        </div>
                    </div>
                     @if (canComplete)
                    {
                        <form asp-controller="Tasks" asp-action="MarkAsCompleted" asp-route-id="@Model.Id" method="post" class="mt-3">
                            <button type="submit" class="btn btn-success"><i class="fas fa-check-circle"></i> Mark as Complete</button>
                        </form>
                    }
                </div>
            </div>

            <!-- Subtasks -->
            <div class="task-item">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                         <h5 class="card-title" style="color: var(--primary-color);">Sub-Tasks</h5>
                         @if (User.IsInRole("Admin"))
                         {
                            <a asp-action="Create" asp-route-parentTaskId="@Model.Id" asp-route-projectId="@Model.ProjectId" class="btn btn-sm btn-success"><i class="fas fa-plus"></i> Add Sub-task</a>
                         }
                    </div>
                    @if (Model.SubTasks != null && Model.SubTasks.Any())
                    {
                        @await Html.PartialAsync("_TaskList", Model.SubTasks)
                    }
                    else
                    {
                        <p style="color: var(--text-muted);">No sub-tasks yet.</p>
                    }
                </div>
            </div>
        </div>

        <!-- Side Panel for Assignments and Completions -->
        <div class="col-lg-4">
            <div class="task-item mb-4 p-0">
                <div class="card-header bg-transparent border-bottom" style="border-color: var(--border-color); color: var(--text-color);">Assigned Users</div>
                <ul class="list-group list-group-flush">
                    @if (Model.TaskAssignments != null && Model.TaskAssignments.Any())
                    {
                        @foreach (var assignment in Model.TaskAssignments)
                        {
                            <li class="list-group-item bg-transparent" style="color: var(--text-color); border-bottom: 1px solid var(--border-color);">@assignment.User?.UserName</li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item bg-transparent" style="color: var(--text-muted);">Not assigned to anyone.</li>
                    }
                </ul>
            </div>

            <div class="task-item p-0">
                <div class="card-header bg-transparent border-bottom" style="border-color: var(--border-color); color: var(--text-color);">Completion History</div>
                 <ul class="list-group list-group-flush">
                    @if (Model.TaskCompletions != null && Model.TaskCompletions.Any())
                    {
                        @foreach (var completion in Model.TaskCompletions.OrderByDescending(c => c.CompletionDate))
                        {
                            <li class="list-group-item bg-transparent d-flex justify-content-between" style="color: var(--text-color); border-bottom: 1px solid var(--border-color);">
                                <span>@completion.User?.UserName</span>
                                <small style="color: var(--text-muted);">@completion.CompletionDate.ToString("yyyy-MM-dd HH:mm")</small>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item bg-transparent" style="color: var(--text-muted);">No one has completed this task yet.</li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>
