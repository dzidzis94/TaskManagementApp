@model TaskManagementApp.Models.TaskItem
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Task Details";
    var currentUserId = UserManager.GetUserId(User);
    var isAssigned = Model.TaskAssignments.Any(ta => ta.UserId == currentUserId);
    var hasCompleted = Model.TaskCompletions.Any(tc => tc.UserId == currentUserId);
    var canComplete = isAssigned && !hasCompleted;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-3">@Model.Title</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 m-0">
                    @if (Model.ProjectId.HasValue)
                    {
                        <li class="breadcrumb-item"><a asp-controller="Projects" asp-action="Details" asp-route-id="@Model.ProjectId">@Model.Project?.Name</a></li>
                    }
                    else
                    {
                        <li class="breadcrumb-item"><a asp-controller="Tasks" asp-action="Index">General Tasks</a></li>
                    }
                    @if (Model.ParentTaskId.HasValue)
                    {
                        <li class="breadcrumb-item"><a asp-controller="Tasks" asp-action="Details" asp-route-id="@Model.ParentTaskId">...</a></li>
                    }
                    <li class="breadcrumb-item active" aria-current="page" style="color: var(--text-color);">@Model.Title</li>
                </ol>
            </nav>
        </div>
        <div>
            <a asp-action="Index" asp-route-projectId="@Model.ProjectId" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>
            @if (User.IsInRole("Admin"))
            {
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary"><i class="fas fa-edit"></i> Edit</a>
            }
        </div>
    </div>
    <hr style="border-color: var(--border-color);" />

    <div class="row">
        <!-- Main Task Details -->
        <div class="col-lg-8">
            <div class="task-item @("task-priority-" + Model.Priority) mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0" style="color: var(--primary-color);">Description</h5>
                    <span class="status-badge @(Model.Status == TaskManagementApp.Models.TaskStatus.Completed ? "status-completed" : Model.Status == TaskManagementApp.Models.TaskStatus.InProgress ? "status-in-progress" : "status-pending")">@Model.Status</span>
                </div>

                <p class="card-text" style="color: var(--text-color);">@Model.Description</p>
                <hr style="border-color: var(--border-color);" />

                <div class="row text-muted small">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <strong style="color: var(--text-color);">Due Date:</strong> <br>
                            <i class="fas fa-calendar-alt me-2"></i> @(Model.DueDate?.ToString("yyyy-MM-dd") ?? "Not set")
                        </div>
                         <div class="mb-2">
                             <strong style="color: var(--text-color);">Priority:</strong> <br>
                             <span class="badge @(Model.Priority == TaskManagementApp.Models.TaskPriority.High ? "bg-danger" : Model.Priority == TaskManagementApp.Models.TaskPriority.Medium ? "bg-warning text-dark" : "bg-info text-dark")">@Model.Priority</span>
                         </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-2">
                            <strong style="color: var(--text-color);">Created by:</strong> <br>
                            <i class="fas fa-user-edit me-2"></i> @Model.CreatedBy?.UserName
                        </div>
                        <div class="mb-2">
                            <strong style="color: var(--text-color);">Created at:</strong> <br>
                            <i class="fas fa-clock me-2"></i> @Model.CreatedAt.ToString("g")
                        </div>
                    </div>
                </div>

                 @if (canComplete)
                {
                    <form asp-controller="Tasks" asp-action="MarkAsCompleted" asp-route-id="@Model.Id" method="post" class="mt-3">
                        <button type="submit" class="btn btn-success"><i class="fas fa-check-circle"></i> Mark as Complete</button>
                    </form>
                }
            </div>

            <!-- Subtasks -->
            <div class="task-item">
                <div class="d-flex justify-content-between align-items-center mb-3">
                     <h5 class="card-title mb-0" style="color: var(--primary-color);">Sub-Tasks</h5>
                     @if (User.IsInRole("Admin"))
                     {
                        <a asp-action="Create" asp-route-parentTaskId="@Model.Id" asp-route-projectId="@Model.ProjectId" class="btn btn-sm btn-success"><i class="fas fa-plus"></i> Add Sub-task</a>
                     }
                </div>

                @if (Model.SubTasks != null && Model.SubTasks.Any())
                {
                    <div class="sub-tasks">
                         @await Html.PartialAsync("_TaskList", Model.SubTasks.Select(MapToSummary))
                    </div>
                }
                else
                {
                    <p style="color: var(--text-muted);">No sub-tasks yet.</p>
                }
            </div>
        </div>

        <!-- Side Panel for Assignments and Completions -->
        <div class="col-lg-4">
            <div class="task-item mb-4 p-0 overflow-hidden">
                <div class="p-3 border-bottom" style="border-color: var(--border-color); background-color: rgba(0,0,0,0.02);">
                    <h6 class="mb-0 fw-bold" style="color: var(--text-color);">Assigned Users</h6>
                </div>
                <ul class="list-group list-group-flush">
                    @if (Model.TaskAssignments != null && Model.TaskAssignments.Any())
                    {
                        @foreach (var assignment in Model.TaskAssignments)
                        {
                            <li class="list-group-item bg-transparent" style="color: var(--text-color); border-bottom: 1px solid var(--border-color);">
                                <i class="fas fa-user me-2 text-muted"></i> @assignment.User?.UserName
                            </li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item bg-transparent" style="color: var(--text-muted);">Not assigned to anyone.</li>
                    }
                </ul>
            </div>

            <div class="task-item p-0 overflow-hidden">
                 <div class="p-3 border-bottom" style="border-color: var(--border-color); background-color: rgba(0,0,0,0.02);">
                    <h6 class="mb-0 fw-bold" style="color: var(--text-color);">Completion History</h6>
                </div>
                 <ul class="list-group list-group-flush">
                    @if (Model.TaskCompletions != null && Model.TaskCompletions.Any())
                    {
                        @foreach (var completion in Model.TaskCompletions.OrderByDescending(c => c.CompletionDate))
                        {
                            <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center" style="color: var(--text-color); border-bottom: 1px solid var(--border-color);">
                                <span><i class="fas fa-check text-success me-2"></i> @completion.User?.UserName</span>
                                <small style="color: var(--text-muted);">@completion.CompletionDate.ToString("yyyy-MM-dd HH:mm")</small>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item bg-transparent" style="color: var(--text-muted);">No one has completed this task yet.</li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@functions {
    TaskManagementApp.ViewModels.TaskSummaryViewModel MapToSummary(TaskManagementApp.Models.TaskItem task)
    {
        return new TaskManagementApp.ViewModels.TaskSummaryViewModel
        {
            Id = task.Id,
            Title = task.Title,
            Description = task.Description,
            Status = task.Status,
            Priority = task.Priority,
            DueDate = task.DueDate,
            ProjectId = task.ProjectId,
            ParentTaskId = task.ParentTaskId,
            CreatedAt = task.CreatedAt,
            AssignedUserNames = task.TaskAssignments?.Where(ta => ta.User != null).Select(ta => ta.User.UserName).ToList() ?? new List<string>(),
            AssignedUserIds = task.TaskAssignments?.Select(ta => ta.UserId).ToList() ?? new List<string>(),
            CompletedUserNames = task.TaskCompletions?.Where(tc => tc.User != null).Select(tc => tc.User.UserName).ToList() ?? new List<string>(),
            CompletedUserIds = task.TaskCompletions?.Select(tc => tc.UserId).ToList() ?? new List<string>(),
            SubTasks = task.SubTasks?.Select(MapToSummary).ToList() ?? new List<TaskManagementApp.ViewModels.TaskSummaryViewModel>()
        };
    }
}
